const privateMap=new WeakMap,initPrivate=e=>privateMap.set(e,{}),$=e=>privateMap.get(e);export class Manager{constructor(e){const t=this;initPrivate(t);const n=$(t);n.gen=0,n.intentToRun=0,n.dataSourceKey=Symbol("dataSource"),n.observables=new WeakMap,n.options={enabled:!0,immediateReaction:!1,maxIterations:10,watchKey:"$$watch",watchDeepKey:"$$watchDeep",afterRun:null,timeLimit:50,getTime:"undefined"!=typeof performance?()=>performance.now():()=>Date.now()},n.callStack=[],n.reactionsToUpdate=new Set,t.setOptions(e),t.makeObservable=t.makeObservable.bind(t),t.makeReaction=t.makeReaction.bind(t),t.makeComputed=t.makeComputed.bind(t),t.makeUpdatable=t.makeUpdatable.bind(t),t.mapProperties=t.mapProperties.bind(t),t.isObservable=t.isObservable.bind(t),t.getDataSource=t.getDataSource.bind(t),t.observable=t.makeObservable,t.reaction=t.makeReaction,t.computed=t.makeComputed,t.updatable=t.makeUpdatable,"undefined"!=typeof process&&"test"===process.env.NODE_ENV&&(t.$$=n)}mapProperties(e,t,n){[].concat(n||Object.keys(e)).forEach(n=>{Object.defineProperty(t,n,{enumerable:!0,get(){return Reflect.get(e,n,this)},set(t){return Reflect.set(e,n,t,this)}})})}setOptions(e={}){$(this).options=Object.assign($(this).options,e)}getOptions(){return Object.assign({},$(this).options)}makeObservable(e){const t=this,n=$(t);if(!e)return e;if(e.constructor!==Object&&e.constructor!==Array&&"function"!=typeof e)return e;if(t.isObservable(e))return e;const a=Array.isArray(e);let o=n.observables.get(e);if(!o){const i=new Map,r={};Object.keys(e).forEach(n=>{const a=Object.getOwnPropertyDescriptor(e,n);a&&"function"==typeof a.get&&(r[n]=t.makeUpdatable(a.get))});const c=e=>{e.invalidIteration=!0,e.onInvalidate&&e.onInvalidate(),e.valid&&(e.valid=!1,e.deps.forEach(e=>c(e))),e.deps.clear()},s=e=>{const t=new Set;return i.set(e,t),t};let l=!1;const p=(a,c)=>{const p=c===n.options.watchDeepKey?n.options.watchKey:c;if(c===n.options.watchDeepKey){if(l)return;l=!0,Object.keys(e).forEach(a=>{if("object"==typeof e[a]){t.makeObservable(e[a])[n.options.watchDeepKey]}}),l=!1}p===n.options.watchKey&&Object.keys(r).forEach(e=>{r[e].call(o)});const u=i.get(p)||s(p);u.has(a)||(u.add(a),a.uninitMap.set(e,e=>{u.delete(e),0===u.size&&i.delete(p)}))},u={toUpdate:i,dataSource:e,registerRead:p},d=e=>{const a=e=>c(e);if(null==e)[...u.toUpdate.values()].forEach(e=>e.forEach(a));else{const t=u.toUpdate.get(e);t&&t.forEach(a);const o=u.toUpdate.get(n.options.watchKey);o&&o.forEach(a)}n.inRunSection||1!==n.intentToRun||(n.options.immediateReaction?t.run():t.runDeferred())};o=new Proxy(e,{get:(o,i,r)=>{if(i===n.dataSourceKey)return e;let c;if(n.callStack.length&&(c=n.callStack[n.callStack.length-1],p(c,i)),i===n.options.watchKey||i===n.options.watchDeepKey)return r;const s=Reflect.get(o,i,r);return a&&"function"==typeof s&&"constructor"!==i?new Proxy(s,{apply:(t,a,o)=>{const r=n.callStack.length?n.callStack[n.callStack.length-1]:null;if(r&&p(r,n.options.watchKey),["copyWithin","fill","pop","push","reverse","shift","sort","splice","unshift"].includes(i)){n.intentToRun++;try{d()}finally{n.intentToRun--}}return t.apply(e,o)}}):"object"==typeof s?t.makeObservable(s):s},set:(e,t,a,o)=>{if(a!==Reflect.get(e,t,o)||Array.isArray(e)&&"length"===t){n.intentToRun++;try{Reflect.set(e,t,a,o),d(t)}finally{n.intentToRun--}}return!0},defineProperty:(e,n,a)=>(a&&"function"==typeof a.get&&(r[n]=t.makeUpdatable(a.get)),Reflect.defineProperty(e,n,a)),deleteProperty:(e,t)=>{n.intentToRun++;try{t in r&&delete r[t],d(t)}finally{n.intentToRun--}return Reflect.deleteProperty(e,t)}}),n.observables.set(e,o)}return o}makeUpdatable(e,t={}){if(e.originalFn)return e;const n=t.onInvalidate,a=t.onUninit,o=$(this),i={id:++o.gen,active:!0,valid:!1,onInvalidate:n,onUninit:a,value:void 0,deps:new Set,uninitMap:new Map,uninit:()=>{[...i.uninitMap.values()].forEach(e=>e(i)),i.uninitMap.clear()}},r=function(){if(!i.active)return e.call(this,this);if(i.computing)console.warn('Detected cross reference inside computed properties! "undefined" will be returned to prevent infinite loop');else{if(o.callStack.length&&i.deps.add(o.callStack[o.callStack.length-1]),i.valid)return i.value;i.computing=!0,i.uninit(),o.callStack.push(i);try{const t=this?o.observables.get(this)||this:null;i.invalidIteration=!1;const n=e.call(t,t);return i.valid=!i.invalidIteration,i.value=n,n}finally{i.computing=!1,o.callStack.pop()}}};return r.uninit=()=>{i.uninit(),i.active=!1,a&&a()},r.originalFn=e,r}makeComputed(e,t,n,a){Object.defineProperty(e,t,{enumerable:!0,configurable:!0,get:this.makeUpdatable(n),set:a})}makeReaction(e,t=!0){const n=this,a=$(n),o=n.makeUpdatable(e,{onInvalidate:()=>a.reactionsToUpdate.add(o),onUninit:()=>a.reactionsToUpdate.delete(o)});return a.reactionsToUpdate.add(o),t&&(a.options.immediateReaction?n.run():n.runDeferred()),o}getDataSource(e){return e[$(this).dataSourceKey]}isObservable(e){return null!=e[$(this).dataSourceKey]}run(e){const t=this,n=$(t);if(n.options.enabled){n.inRunSection=!0;try{"function"==typeof e&&e(),n.runScheduled=!1;let a=0;for(;n.reactionsToUpdate.size;){if(a>n.options.maxIterations)throw n.reactionsToUpdate.clear(),new Error("Max iterations exceeded!");a++;const e=n.options.getTime(),o=[...n.reactionsToUpdate.values()];for(const t of o)if(n.reactionsToUpdate.delete(t),t(),n.options.getTime()-e>=n.options.timeLimit)break;n.reactionsToUpdate.size&&t.runDeferred()}"function"==typeof n.options.afterRun&&n.options.afterRun()}finally{n.inRunSection=!1}}}runDeferred(e,t=0){const n=$(this);if(n.options.enabled){n.inRunSection=!0;try{n.runScheduled||(n.runScheduled=setTimeout(()=>this.run(),t)),"function"==typeof e&&e()}finally{n.inRunSection=!1}}}}Manager.default=new Manager,Manager.default.Manager=Manager;export default Manager.default;export const observable=Manager.default.observable;export const reaction=Manager.default.reaction;export const computed=Manager.default.computed;export const updatable=Manager.default.updatable;
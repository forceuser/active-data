<!doctype html>
<html>

	<head>
		<title>active-view demo</title>
		<script src="./dist/active-data.js"></script>
	</head>

	<body>
	  <button>RUN</button>
		<script>
			const m = activeData;

			function test1() {
				m.setOptions({
					immediateReaction: true
				});
				const d = m.makeObservable({
					a: 1,
					b: 2
				});
				const comp = self => self.a + self.b;
				m.makeComputed(d, "comp", comp);
				const comp2 = self => self.comp + "comp 2";
				const comp3 = self => self.comp + "comp 3";
				m.makeComputed(d, "comp2", comp2);
				m.makeComputed(d, "comp3", comp3);
				const reaction1 = () => d.comp2 + "reaction 1";
				const reaction2 = () => d.comp2 + "reaction 2";
				m.makeReaction(reaction1);
				m.makeReaction(reaction2);
				d.a = 5123;
			}

			function test2() {
				m.setOptions({
					immediateReaction: true
				});
				const srcProtoProto = {};
				const srcProto = Object.create(srcProtoProto);
				const src = Object.create(srcProto);
				const $srcProtoProto = m.makeObservable(srcProtoProto);
				const $srcProto = m.makeObservable(srcProto);
				const $src = m.makeObservable(src);
				srcProtoProto.a = 1;
				// srcProto.a = 2;
				src.a = 3;

				function updatable() {
					console.log(`${$srcProtoProto.a} ${$src.a}`);
				}
				m.makeReaction(updatable);

				setTimeout(() => {
					$srcProtoProto.a = 11;
				}, 2000);

			}

			function test3() {
				m.setOptions({
					immediateReaction: true
				});

				function makeLongPrototypeChain(maxlength = 1, res = []) {
					if (res.length === maxlength) {
						return res;
					}
					if (!res.length) {
						res.push({
							n: 0
						});
					} else {
						const obj = Object.create(res[res.length - 1]);
						obj.n = res.length;
						res.push(obj);
					}
					return makeLongPrototypeChain(maxlength, res);
				}

				chain = makeLongPrototypeChain(10);
				chain[0].a = 0;
				// chain[4].a = 4;

				const observables = {};
				[0, 3, 7].forEach(i => {
					observables[i] = m.makeObservable(chain[i]);
				});

				m.makeReaction(() => `${observables[7].a} ${observables[0].a}`);
				// setTimeout(() => {
				// 	observables[3].a = 9;
				// }, 2000);

			}

			function scopeExample () {
			  const ad = activeData;
			  const isolatedScope = ad.makeObservable({});

			  function createRootScope() {
				  return ad.makeObservable({
					  $child: [],
					  $new (isolated = false, extend) {
						  const data = ad.isObservable(this) ? ad.getObservableSource(this) : this

						  let scope = Object.create(isolated ? isolatedScope : data);
						  if (typeof extend === "object") {
							  scope = Object.assign(scope, extend);
						  }
						  Object.defineProperties(scope, {
							  "$parent": {
								  value: this,
								  enumerable: false
							  },
							  "$child": {
								  value: [],
								  enumerable: false
							  }
						  })
						  const $scope = ad.makeObservable(scope);
						  data.$child.push($scope);
						  return $scope;
					  },
					  toJSON: function() {
					  var tmp = {};

					  for (var key in this) {
					      if (typeof this[key] !== "function") {
								  tmp[key] = this[key];
							  }
					  }

					  return tmp;
				      }
				  })
			  }

			  const $rootScope = createRootScope();
			  const $scope1 = $rootScope.$new();
			  const $scope2 = $scope1.$new();
			  $scope1.a = {};
			  $scope2.b = 13;
			  ad.makeReaction(() => {
				  console.log(`$scope2.a: ${JSON.stringify($scope2.$$whole)}`);
			  });
			  setTimeout(() => {
				  $scope1.b = 212;
			  }, 2000);

			  setTimeout(() => {
				  $scope1.c = 555;
			  }, 3000);
			}

			function perfTest () {
			  const ad = activeData;
			//   ad.setOptions({
			// 	  immediateReaction: true
			//   });


			  function writeTest (count, obj, mark) {
			    performance.mark(`${mark}-start`);
				const a = [];
			    for (let i = 0; i < count; i++) {
			      a.push(Math.random());
			    }
				obj.a = obj.a.concat(a);
			    performance.mark(`${mark}-end`);
			    performance.measure(`${mark}`, `${mark}-start`, `${mark}-end`);
				const perf = performance.getEntriesByName(`${mark}`)[performance.getEntriesByName(`${mark}`).length - 1];
				return {name: perf.name, duration: perf.duration};
			  }
			  let reader;
			  function readTest (count, obj, mark) {
			    performance.mark(`${mark}-start`);
			    for (let i = 0; i < count; i++) {
			      reader = obj.prop;
			    }
			    performance.mark(`${mark}-end`);
			    performance.measure(`${mark}`, `${mark}-start`, `${mark}-end`);
			    const perf = performance.getEntriesByName(`${mark}`)[performance.getEntriesByName(`${mark}`).length - 1];
				return {name: perf.name, duration: perf.duration};
			  }
			  const regularObj = {a: []};
			  const obsObj = {a: []};
			  const $obsObj = ad.makeObservable(obsObj);
			  const count = Math.pow(10, 6);

			  ad.makeReaction(() => console.log($obsObj.a));

			  setTimeout(() => {
				  console.log(writeTest(count, regularObj, "regular-write"));
				  console.log(writeTest(count, $obsObj, "observable-write"));
				  console.log(readTest(count, regularObj, "regular-read"));
				  console.log(readTest(count, $obsObj, "observable-read"));
			  }, 100);



			}

			document.querySelector("button").addEventListener("click", () => perfTest());
		</script>

	</body>

</html>
